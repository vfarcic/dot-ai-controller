# Mock MCP Server for CapabilityScanConfig E2E Tests
#
# This mock server simulates the MCP manageOrgData endpoint for capability scanning.
# It provides a fixed list of capabilities and tracks all requests for verification.
#
# =============================================================================
# BEHAVIOR SPECIFICATION
# =============================================================================
#
# Fixed Capability List (returned by "list" operation):
#   - "Pod"
#   - "Service"
#   - "FakeStaleCRD.old.example.com"  (orphaned - doesn't exist in cluster)
#
# Endpoints:
#
# 1. POST /api/v1/tools/manageOrgData
#    Handles MCP capability operations based on request body:
#
#    a) operation: "list"
#       Returns: {"success": true, "data": {"result": {"success": true,
#                "capabilities": [{"id": "Pod"}, {"id": "Service"}, {"id": "FakeStaleCRD.old.example.com"}],
#                "totalCount": 3}}}
#
#    b) operation: "scan"
#       Records the request (resourceList field)
#       Returns: {"success": true, "data": {"result": {"success": true,
#                "status": "started", "message": "Scan initiated"}}}
#
#    c) operation: "delete"
#       Records the request (id field)
#       Returns: {"success": true, "data": {"result": {"success": true,
#                "operation": "delete", "message": "Capability deleted"}}}
#
# 2. GET /stats
#    Returns all recorded requests for test verification:
#    {
#      "scanRequests": [
#        {"resourceList": "NewCRD.test.example.com", "timestamp": "..."}
#      ],
#      "deleteRequests": [
#        {"id": "FakeStaleCRD.old.example.com", "timestamp": "..."}
#      ],
#      "listRequests": 2,
#      "totalRequests": 5
#    }
#
# 3. POST /reset
#    Clears all recorded requests (call between tests for isolation)
#    Returns: {"success": true, "message": "Stats reset"}
#
# =============================================================================
# IMPLEMENTATION NOTES
# =============================================================================
#
# The mock needs to:
# 1. Parse JSON request body to determine operation type
# 2. Store requests in memory (or temp file) for stats endpoint
# 3. Return appropriate JSON responses
#
# This is more complex than busybox/netcat - recommend using a small Go binary
# or Python script with Flask/http.server
#
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-capability-scan-server
  namespace: e2e-tests
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mock-capability-scan-server
  template:
    metadata:
      labels:
        app: mock-capability-scan-server
    spec:
      containers:
      - name: mock-server
        image: python:3.11-alpine
        ports:
        - containerPort: 8080
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 65534
        command: ["python3"]
        args:
        - -c
        - |
          import json
          import http.server
          import socketserver
          from datetime import datetime
          from urllib.parse import urlparse

          # In-memory storage for request tracking
          stats = {
              "scanRequests": [],
              "deleteRequests": [],
              "listRequests": 0,
              "totalRequests": 0
          }

          # Fixed capability list
          CAPABILITIES = [
              {"id": "Pod"},
              {"id": "Service"},
              {"id": "FakeStaleCRD.old.example.com"}
          ]

          class Handler(http.server.BaseHTTPRequestHandler):
              def log_message(self, format, *args):
                  print(f"[{datetime.now().isoformat()}] {args[0]}")

              def send_json(self, data, status=200):
                  response = json.dumps(data).encode()
                  self.send_response(status)
                  self.send_header("Content-Type", "application/json")
                  self.send_header("Content-Length", len(response))
                  self.end_headers()
                  self.wfile.write(response)

              def do_GET(self):
                  if self.path == "/stats":
                      self.send_json(stats)
                  elif self.path == "/health":
                      self.send_json({"status": "healthy"})
                  else:
                      self.send_json({"error": "Not found"}, 404)

              def do_POST(self):
                  content_length = int(self.headers.get("Content-Length", 0))
                  body = self.rfile.read(content_length).decode() if content_length > 0 else "{}"

                  try:
                      data = json.loads(body) if body else {}
                  except json.JSONDecodeError:
                      data = {}

                  stats["totalRequests"] += 1

                  if self.path == "/reset":
                      stats["scanRequests"] = []
                      stats["deleteRequests"] = []
                      stats["listRequests"] = 0
                      stats["totalRequests"] = 0
                      self.send_json({"success": True, "message": "Stats reset"})
                      return

                  if "/manageOrgData" in self.path:
                      operation = data.get("operation", "")

                      if operation == "list":
                          stats["listRequests"] += 1
                          self.send_json({
                              "success": True,
                              "data": {
                                  "result": {
                                      "success": True,
                                      "capabilities": CAPABILITIES,
                                      "totalCount": len(CAPABILITIES)
                                  }
                              }
                          })
                      elif operation == "scan":
                          resource_list = data.get("resourceList", "")
                          stats["scanRequests"].append({
                              "resourceList": resource_list,
                              "timestamp": datetime.now().isoformat()
                          })
                          self.send_json({
                              "success": True,
                              "data": {
                                  "result": {
                                      "success": True,
                                      "status": "started",
                                      "message": f"Scan initiated for: {resource_list}"
                                  }
                              }
                          })
                      elif operation == "delete":
                          cap_id = data.get("id", "")
                          stats["deleteRequests"].append({
                              "id": cap_id,
                              "timestamp": datetime.now().isoformat()
                          })
                          self.send_json({
                              "success": True,
                              "data": {
                                  "result": {
                                      "success": True,
                                      "operation": "delete",
                                      "message": f"Capability {cap_id} deleted"
                                  }
                              }
                          })
                      else:
                          self.send_json({
                              "success": True,
                              "data": {"result": {"success": True}}
                          })
                  else:
                      self.send_json({"error": "Not found"}, 404)

          print("Starting mock capability scan server on port 8080...")
          with socketserver.TCPServer(("", 8080), Handler) as httpd:
              httpd.serve_forever()
        resources:
          limits:
            memory: "64Mi"
            cpu: "100m"
          requests:
            memory: "32Mi"
            cpu: "50m"
---
apiVersion: v1
kind: Service
metadata:
  name: mock-capability-scan-server
  namespace: e2e-tests
spec:
  selector:
    app: mock-capability-scan-server
  ports:
  - port: 8080
    targetPort: 8080

apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-knowledge-server
  namespace: e2e-tests
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mock-knowledge-server
  template:
    metadata:
      labels:
        app: mock-knowledge-server
    spec:
      containers:
      - name: mock-server
        image: python:3.12-alpine
        ports:
        - containerPort: 8080
        command: ["python3", "-u"]
        args:
        - -c
        - |
          from http.server import HTTPServer, BaseHTTPRequestHandler
          from socketserver import ThreadingMixIn
          import json

          class Handler(BaseHTTPRequestHandler):
              def log_message(self, format, *args):
                  print(f"{self.client_address[0]} - {format % args}", flush=True)

              def do_POST(self):
                  content_length = int(self.headers.get('Content-Length', 0))
                  body = self.rfile.read(content_length) if content_length > 0 else b''

                  try:
                      data = json.loads(body) if body else {}
                      operation = data.get('operation', 'ingest')
                      uri = data.get('uri', 'unknown')
                      print(f"Operation: {operation}, URI: {uri}", flush=True)

                      response = {
                          "success": True,
                          "operation": operation,
                          "chunksCreated": 2,
                          "chunkIds": ["chunk-1", "chunk-2"],
                          "uri": uri,
                          "message": f"Processed {operation}"
                      }

                      self.send_response(200)
                      self.send_header('Content-Type', 'application/json')
                      self.end_headers()
                      self.wfile.write(json.dumps(response).encode())
                  except Exception as e:
                      print(f"Error: {e}", flush=True)
                      self.send_response(500)
                      self.end_headers()

          class ThreadedHTTPServer(ThreadingMixIn, HTTPServer):
              daemon_threads = True

          print("Starting mock knowledge server on port 8080...", flush=True)
          server = ThreadedHTTPServer(('0.0.0.0', 8080), Handler)
          server.serve_forever()
---
apiVersion: v1
kind: Service
metadata:
  name: mock-knowledge-server
  namespace: e2e-tests
spec:
  selector:
    app: mock-knowledge-server
  ports:
  - port: 8080
    targetPort: 8080
